# bunner-router-rs 필수 후속 작업 계획 (2025-10-16)

아래 항목은 `result.md` 및 최근 코드 검토에서 확인된 **즉시 실행이 필요한 필수 작업**입니다. 각 항목은 우선순위와 근거를 함께 명시했습니다.

## 1. 아레나 포인터 안전성 강화 (P0)
- **작업**: `create_node_box_from_arena_pointer` 경로에서 `unsafe { &*arena_ptr }` 사용을 제거하고, `Arc<Bump>` 또는 안전한 핸들을 도입해 라이프사이클을 보장한다.
- **근거**: `result.md` 2.1(critical risks)에서 생 포인터 재사용 시 U.B. 가능성이 지적됨.
- **완료 조건**: 모든 노드 생성 경로가 안전 API만 사용하고, `// SAFETY:` 주석 없이도 컴파일 타임 검증이 가능해야 함.

## 2. Interner 구조 단순화 및 cleanup 동기화 (P0)
- **작업**: `Interner`의 `RwLock` 이중 구조를 단일 락/동시 맵(`DashMap`)으로 교체하고, `runtime_cleanup`에서 map/rev를 동시에 초기화한다.
- **근거**: `result.md` 2.2, 3.4에서 경합/정합성 문제가 반복 언급됨.
- **완료 조건**: 동시성 테스트(loom)로 교착/데이터 경합이 재현되지 않고, cleanup 이후에도 `intern`이 일관된 ID를 반환.

## 3. 정규화 로직 재작성 및 퍼센트 디코딩 옵션화 (P0)
- **작업**: `path/normalize.rs`에서 ASCII 강제 및 `replace("//", "/")` 루프를 제거하고, 단일 패스 검사 + 옵션 기반 percent-decoding/UTF-8 검증을 구현한다.
- **근거**: `result.md` 2.4와 4.4에서 DoS 가능성과 국제화 제한이 명시됨.
- **완료 조건**: 새로운 정규화가 O(n)에서 종료되고, 옵션으로 percent-decoding을 켜/끌 수 있으며 테스트로 엣지 케이스를 검증.

## 4. Router 캐시 잠금 전략 개선 (P1)
- **작업**: `RouterReadOnly::find`에서 캐시 조회 시 쓰기 잠금 대신 읽기 잠금 → miss 시 쓰기 승격 패턴 또는 lock-free 구조를 도입한다.
- **근거**: `result.md` 3.2, 7.B에서 읽기 편향 워크로드에서의 경합이 지적됨.
- **완료 조건**: 단위/벤치 테스트에서 히트율이 높은 시나리오에서 성능 향상이 확인되고, 동시성 문제 없음.

## 5. RouteMatch & Params API 개선 (P1)
- **작업**: `(u16, Vec<(String, (usize, usize))>)` 대신 복사 최소화된 `Params` 뷰(&str) 및 헬퍼 제공. 파라미터 이름 인터닝 활용 고려.
- **근거**: `result.md` 4.1, 6.2, 7.B에서 문자열 복제 비용과 DX 문제가 반복 지적됨.
- **완료 조건**: 새 API가 기존 테스트를 유지하면서 복사 횟수를 줄이고, 샘플 코드/문서가 추가됨.

## 6. 패턴 제약(Regex) 캐싱 도입 (P1)
- **작업**: 파라미터 제약 문자열을 사전 컴파일해 재사용하고, 반복 매칭 시 재컴파일이 발생하지 않도록 캐시를 설계.
- **근거**: `result.md` 4.2, 7.B에서 런타임 오버헤드가 우려됨.
- **완료 조건**: 프로파일/벤치 결과로 재컴파일 제거 효과를 확인하고, 캐시 수명 관리(메모리 누수 방지)가 보장됨.

## 7. 동시성/퍼즈/벤치 테스트 체계 구축 (P0)
- **작업**: 
  - `loom` 기반 최소 1개의 동시성 시나리오(캐시, interner, seal)를 추가
  - `cargo-fuzz` 타깃으로 파서·정규화 입력 검증 설정
  - 실전 라우트셋 벤치마크를 `benches/`에 추가해 p95/p99 latency 측정
- **근거**: `result.md` 5절, 7.C 전반에 걸친 테스트 부재 지적.
- **완료 조건**: CI에서 새 테스트/벤치가 실행되고, 기본 시나리오가 패스하며 성능 측정 데이터가 확보됨.

## 8. Seal 라이프사이클 문서 및 API 가드 강화 (P0)
- **작업**: 
  - `Router` API 문서에 “seal 이후 add 불가” 라이프사이클을 명확히 기재
  - 예제로 `MutableRouter -> RouterReadOnly` 전환을 제공
  - 필요 시 타입 상태 패턴 도입 검토
- **근거**: `result.md` 2.3, 7.A에서 오용 위험이 언급됨.
- **완료 조건**: 문서/예제가 저장소에 추가되고, seal 이후 사용 시 명확한 에러/가이드를 제공.

---
※ 우선순위(P0=즉시, P1=차기 스프린트) 기준으로 정렬했습니다. 상위 항목들은 상호 의존성이 있으므로 순차적으로 해결하는 것을 권장합니다.
